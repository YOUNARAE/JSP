<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.board.dao.BoardDAO">
<sql id="searchFrag">
 <where>
   	<if test="simpleCondition neq null and @org.apache.commons.lang3.StringUtils@isNotBlank(simpleCondition.searchWord)">
   		<choose>
   			<when test="simpleCondition.searchType eq 'writer'">
   				INSTR(BO_WRITER, #{simpleCondition.searchWord}) > 0
   			</when>
   			<when test="simpleCondition.searchType eq 'content'">
   				INSTR(BO_CONTENT, #{simpleCondition.searchWord}) > 0
   			</when>
   			<otherwise>
   				INSTR(BO_WRITER, #{simpleCondition.searchWord}) > 0
   				OR
   				INSTR(BO_CONTENT, #{simpleCondition.searchWord}) > 0
   			</otherwise>
   		</choose>
   	</if>
   </where>
</sql>

<select id="selectTotalRecord" resultType="int" parameterType="PagingVO"><!-- 검색기능 where를 붙여야해서 파라미터 타입이 붙는다 -->
    SELECT COUNT(*)
      FROM FREEBOARD
      <include refid="searchFrag" />
 </select>

 <select id="selectBoardList" resultType="BoardVO" parameterType="PagingVO"> <!-- 첫페이지,끝페이지 불러와야해서 파라미터 불러오고 질의의 타입이 필요하니까 resultType -->
      WITH ORDERDBOARD AS (
		   SELECT BO_NO, BO_TITLE, BO_WRITER, BO_MAIL, BO_DATE, BO_HIT,
		          ( SELECT COUNT(ATT_NO) 
		              FROM ATTATCH
		             WHERE ATTATCH.BO_NO = FREEBOARD.BO_NO
		           ) ATT_COUNT  
		     FROM FREEBOARD
		   	 <include refid="searchFrag" />
		 ORDER BY BO_NO DESC
		) SELECT A.*
		    FROM (
		           SELECT ROWNUM RNUM, ORDERDBOARD.*
		           FROM ORDERDBOARD
		         ) A
		   WHERE RNUM BETWEEN #{startRow} AND #{endRow}
   </select>


</mapper>
